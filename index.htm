<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Ricette28k</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link href="css/bootstrap.min.css" rel="stylesheet">
<style>
body {
 padding-top: 55px;}
#righe tr {
 cursor: pointer;}
</style>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top hidden">
 <div class="container-fluid">
  <div class="navbar-header">
   <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
    <span class="sr-only">Toggle navigation</span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
   </button>
   <span class="navbar-brand">Ricette28k</span>
  </div>
  <div id="navbar" class="navbar-collapse collapse">
   <ul class="nav navbar-nav">
    <li><a href="javascript:$('.navbar-toggle').click();mostraricerca();">Ricerca <span class="glyphicon glyphicon-search"></span></a></li>
    <li><a href="javascript:$('.navbar-toggle').click();info();">Info</a></li>
   </ul>
  </div>
 </div>
</nav>

<div class="container" id="presenta">
 <div class="jumbotron">
  <h1>Ricette28k</h1>
  <small>Autore: Fabrizio Fellini<br>Versione 20240304.1<br></small>
  <a class="btn btn-primary hidden" id="olInstall" href="javascript:void(0);">Installa offline</a>
  <a class="btn btn-primary hidden" id="dbInstall" href="javascript:void(0);">Installa ricette</a>
 </div>
 <div class="row hidden" id="progresso">
  <div class="progress col-xs-10 col-xs-offset-1">
   <div class="progress-bar" style="width: 0%;">
   </div>
  </div>
 </div>
</div>

<div class="container hidden" id="cerca">
 <form name="f" class="form-horizontal">
  <h3>Ricerca ricette</h3>
  <div class="form-group">
   <label class="col-xs-4 control-label">Nome ricetta</label>
   <div class="col-xs-8">
    <input type="text" class="form-control" name="nome">
   </div>
  </div>
  <div class="form-group">
   <label class="col-xs-4 control-label">Tipo</label>
   <div class="col-xs-8">
    <select multiple class="form-control" name="tipo">
    </select>
   </div>
  </div>
  <div class="form-group">
   <label class="col-xs-4 control-label">Ingrediente principale</label>
   <div class="col-xs-8">
    <input type="text" class="form-control mod" name="ingprinc">
   </div>
  </div>
  <div class="form-group">
   <label class="col-xs-4 control-label">Ingredienti (seperati da virgole)</label>
   <div class="col-xs-8">
    <input type="text" class="form-control mod" name="ingre">
   </div>
  </div>
  <div class="form-group">
   <div class="col-xs-8 col-xs-offset-4">
    <button type="submit" class="btn btn-lg btn-primary btn-block">Cerca</button>
   </div>
  </div>
 </form>
</div>

<div class="container hidden" id="risult">
 <h3>Risultati ricerca</h3>
 <div class="row">
  <div class="table-responsive col-xs-12">
   <table class="table table-striped">
    <caption>0 ricette trovate</caption>
    <thead>
     <tr>
      <th>#</th>
      <th>Nome ricetta</th>
      <th>Tipo</th>
      <th>Ingrediente principale</th>
      <th>Persone</th>
      <th>Note</th>
      <th>Calorie</th>
     </tr>
    </thead>
    <tbody id="righe">
    </tbody>
   </table>
  </div>
 </div>
</div>

<div class="modal fade" id="modWait" tabindex="-1" role="dialog" data-backdrop="static">
 <div class="modal-dialog modal-sm" role="document">
  <div class="modal-content">
   <div class="modal-header">
    <h4 class="modal-title">
     <span class="glyphicon glyphicon-time"></span> Attendere...
    </h4>
   </div>
   <div class="modal-body">
    <p>Elaborazione in corso.</p>
   </div>
  </div>
 </div>
</div>

<div class="modal fade" id="modRicetta" tabindex="-1" role="dialog">
 <div class="modal-dialog modal-lg" role="document">
  <div class="modal-content">
   <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span style="font-size: 40px;" aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">Modal title</h4>
   </div>
   <div class="modal-body">
    <dl>
     <dt>Ingredienti:</dt>
     <dd id="modIng"></dd>
     <dt>Preparazione:</dt>
     <dd id="modPre"></dd>
    </dl>
   </div>
  </div>
 </div>
</div>

<script src="js/jquery-1.12.4.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>
<!--
const numricette=28200,
 segl=100000,
 numseg=203,
 nomeDB='r28k.db';

var dbready=false,r28kStatus,ricetteDB;

$(function(){
 if (!('indexedDB' in window)){
  alert('Impossibile caricare le ricette:\nIndexedDB non è supportato!');
  return;
 } else {
  if (localStorage.getItem('r28kstatus')===null){
   r28kStatus=0;
   deleteDB();
  } else {
   r28kStatus=parseInt(localStorage.r28kstatus,10);
  }
  if ((r28kStatus&1)==0){//installa offline
   $('#olInstall')
   .click(function(event){
    event.preventDefault();
    $(this).addClass('hidden');
    r28kStatus=(r28kStatus|1);
    localStorage.r28kstatus=r28kStatus;
    swLoad();
   })
   .removeClass('hidden');
  } else {
   swLoad();
  }
  if ((r28kStatus&2)==0){//installa db
   $('#dbInstall')
   .click(function(event){
    event.preventDefault();
    $(this).addClass('hidden');
    r28kStatus=(r28kStatus|2);
    localStorage.r28kstatus=r28kStatus;
    iniziaDB();
    ctrlDB();
   })
   .removeClass('hidden');
  } else {
   iniziaDB();
   ctrlDB();
  }
 }
});

function cella(t){
 var h=htmlentities(t);
 return '<td>'+h.replace(/\n/g,'<br />')+'</td>';
}

function cerca(){
 $('#modWait').modal('show');
 setTimeout(function(){cercacb0();},0);
}

function cercacb0(){
 var a,ar,f,filtro,i,n,r,ricette,tx;
 a=new Array();
 n=trim(document.f.nome.value);
 if (n.length>0){
  f=new RegExp(escapeRegExp(n),'i');
  a.push('riga.nome.match('+f+')');
 }
 n=$(document.f.tipo).val();
 if (n){
  f='([';
  for (i=0;i<n.length;i++){
   if (i>0)
    f+=',';
   f+=quotedstr(n[i]);
  }
  f+='].indexOf(riga.tipo)>-1)';
  a.push(f);
 }
 n=trim(document.f.ingprinc.value);
 if (n.length>0){
  f=new RegExp(escapeRegExp(n),'i');
  a.push('riga.ingprinc.match('+f+')');
 }
 n=trim(document.f.ingre.value);
 if (n.length>0){
  n=n.split(',');
  for (i=0;i<n.length;i++){
   f=new RegExp(escapeRegExp(trim(n[i])),'i');
   a.push('riga.ingre.match('+f+')');
  }
 }
 if (a.length==0){
  $('#modWait').modal('hide');
  alert('Ricercare almeno qualcosa...');
  return;
 }
 if (a.length==1)
  f=a[0];
 else {
  f='(';
  for (i=0;i<a.length;i++){
   if (i>0)
    f+='&&';
   f+=a[i];
  }
  f+=')';
 }
 filtro=new Function('riga','return '+f+';');
 ar=[];
 tx=ricetteDB.transaction(['ricette']);
 ricette=tx.objectStore('ricette');
 r=ricette.openCursor();
 r.onsuccess=function(){
  var c,riga;
  c=r.result;
  if (c){
   riga=c.value;
   if (filtro(riga)) ar.push(riga);
   c.continue();
  }
 };
 tx.oncomplete=function(){
  ar.sort(function(a,b){
   return ((a.tipo==b.tipo)?((a.nome>b.nome)?1:-1):((a.tipo>b.tipo)?1:-1));
  });
  cercacb1(ar);
 };
}

function cercacb1(results){
 var h,i,k,r,rig;
 rig=results.length;
 $('#righe').html('');
 $('caption').text('Ricette trovate: '+rig);
 $('#cerca').addClass('hidden');
 $('#risult').removeClass('hidden');
 i=0;
 $('#modWait').modal('hide');
 return cercacb2();
 function cercacb2(){
  k=0;
  while (i<rig){
   r=results[i];;
   h='<tr data-ing="'+datat(r['ingre'])+'" data-pre="'+datat(r['prep'])+'">';
   h+='<td>'+(i+1)+'</td>';
   h+=cella(r['nome']);
   h+=cella(r['tipo']);
   h+=cella(r['ingprinc']);
   h+=cella(r['persone']);
   h+=cella(r['note']);
   h+=cella(r['calorie']);
   $('#righe').append(h);
   i++;
   k++;
   if (k>19){
    setTimeout(function(){cercacb2();},0);
    return;
   }
  }
 }
}

function ctrlDB(){
 if (dbready){
  settipi();
  setTimeout(function(){mostraricerca();},2000);
 } else
 setTimeout(function(){ctrlDB();},1000);
}

function datat(t){
 var h=t.replace(/\n/g,'<br />')
 return htmlentities(h);
}

function deleteDB(){
 var r;
 r=indexedDB.deleteDatabase(nomeDB);
 r.onerror=function(){
  console.error('Errore',r.error);
 };
}

function escapeRegExp(string) {
 return string.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); // $& means the whole matched string
}

function htmlentities(str) {
 return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');//"
}

function importaDB(){
 var seg=0;
 var sql='';
 var sqlold='';
 $('#progresso').removeClass('hidden');
 setTimeout(function(){inviadati();},0);

 function inviadati(){
  $.get(
   'sql/ricette'+('00'+seg).slice(-3)+'.sql',
   function(data,status){
    if (status=='success'){
     sqlold=sql;
     sql+=data;
     setTimeout(function(){ciclo();},0);
    } else {
     alert('Si è verificato un problema!');
    }
   }
  );
 }

 function ciclo(){
  var ar,i,j,linee,r,ricette,riga,s,tx,totl;
  linee=sql.split(');\n');
  totl=linee.length-1;
  sql=linee[totl];
  tx=ricetteDB.transaction(['ricette'],'readwrite');
  tx.oncomplete=function(){
   var p=String(Math.round(seg/numseg*100))+'%';
   $('.progress-bar')
   .css("width",p)
   .text(p);
   if (seg>=numseg){
    setTimeout(function(){
     alert('Importazione database conclusa con successo!');
     $('#progresso').addClass('hidden');
     dbready=true;
    },0);
   } else {
    seg++;
    setTimeout(function(){inviadati();},0);
   }
  }
  ricette=tx.objectStore('ricette');
  for(i=0;i<totl;i++){
   ar=[];
   s=trim(linee[i].substr(linee[i].indexOf('(')+1))+',';
   j=0;
   while(s.length>0){
    if (s.charAt(0)=="'"){
     j=1;
     while(j=s.indexOf("'",j)){
      if (s.charAt(j+1)!="'")
       break;
      else
       j+=2;
     }
     ar.push(s.slice(1,j).replace(/''/g,"'"));
     s=ltrim(s.substr(s.indexOf(',',j)+1));
    } else {
     j=s.indexOf(',');
     ar.push(rtrim(s.substr(0,j)));
     s=ltrim(s.substr(j+1));
    }
   }
   riga={
    'id':parseInt(ar[0],10),
    'nome':ar[1],
    'tipo':ar[2],
    'ingprinc':ar[3],
    'persone':parseInt(ar[4],10),
    'note':ar[5],
    'ingre':ar[6],
    'prep':ar[7],
    'calorie':parseInt(ar[8],10)};
   r=ricette.put(riga);
   r.onerror=function(){
    console.error('Errore',r.error);
   }
  }
 }
}

function info(){
 if ($('#presenta').hasClass('hidden'))
  $('#presenta').removeClass('hidden');
 setTimeout(function(){ alert("Questa Web-App utilizza l'archivio\nDBRICETTE di Giorgio Musilli (www.dbricette.it).");},0);
 setTimeout(function(){$('#presenta').addClass('hidden');},5000);
}

function iniziaDB(){
 var r;
 r=indexedDB.open(nomeDB,1);
 r.onupgradeneeded=function(){
  ricetteDB=r.result;
  if (!ricetteDB.objectStoreNames.contains('ricette')){
   ricetteDB.createObjectStore('ricette',{keyPath:'id'});
  }
 };
 r.onerror=function(){
   console.error('Errore',r.error);
 };
 r.onsuccess=function(){
  var c,ricette,tx;
  ricetteDB=r.result;
  tx=ricetteDB.transaction(['ricette']);
  ricette=tx.objectStore('ricette');
  c=ricette.count();
  c.onsuccess=function(){
   if (c.result<numricette) importaDB();
   else dbready=true;
  }
 };
}

function ltrim(stringToTrim) {
 return stringToTrim.replace(/^\s+/,"");
}

function mostraricerca(){
 if ($('nav').hasClass('hidden'))
  $('nav').removeClass('hidden');
 if (!($('#presenta').hasClass('hidden')))
  $('#presenta').addClass('hidden');
 if ($('#cerca').hasClass('hidden'))
  $('#cerca').removeClass('hidden');
 if (!($('#risult').hasClass('hidden')))
  $('#risult').addClass('hidden');
}

function quotedstr(str) {
 return "'"+String(str).replace(/'/g, "''")+"'";//"
}

function rtrim(stringToTrim) {
 return stringToTrim.replace(/\s+$/,"");
}

function settipi(){
 var ar,r,ricette,tx;
 ar=[];
 tx=ricetteDB.transaction(['ricette']);
 ricette=tx.objectStore('ricette');
 r=ricette.openCursor();
 r.onsuccess=function(){
  var c,riga;
  c=r.result;
  if (c){
   riga=c.value;
   if (ar.indexOf(riga.tipo)<0) ar.push(riga.tipo);
   c.continue();
  }
 };
 tx.oncomplete=function(){
  ar.sort();
  var h,i,o;
  h='<optgroup disabled hidden></optgroup>';
  for (i=0;i<ar.length;i++){
   o=htmlentities(ar[i]);
   h+='<option value="'+o+'">'+o+'</option>';
  }
  $(document.f.tipo)
   .html(h);
  $(document.f).on('submit',function(event){
   cerca();
   return false;
  });
  $('#righe').on('click','tr',function(){
   var i,pr,t;
   r=$(this);
   t=r.find('td');
   $('#modRicetta').find('.modal-title').html(t.eq(1).text()+' <small>'+t.eq(2).text()+' per '+t.eq(4).text()+' persone</small>');
   i=r.data('ing');
   p=r.data('pre');
   $('#modIng').html(i);
   $('#modPre').html(p);
   $('#modRicetta').modal('show');
  });
 };
}

function swLoad(){
 if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
  .then(function(registration){
   console.log('Registration successful, scope is:', registration.scope);
  })
  .catch(function(error){
   console.log('Service worker registration failed, error:', error);
  });
 }
}

function trim(stringToTrim) {
 return stringToTrim.replace(/^\s+|\s+$/g,"");
}
-->
</script>
</body>
</html>